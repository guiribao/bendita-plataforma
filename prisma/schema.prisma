// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider     = "postgres"
  url          = env("DATABASE_URL")
  relationMode = "prisma"
}

model Usuario {
  id            Int      @id @default(autoincrement())
  email         String   @unique
  senha         String   @db.VarChar(100)
  papel         Papel    @default(ASSOCIADO)
  criado_em     DateTime @default(now()) @db.Timestamptz()
  atualizado_em DateTime @updatedAt @db.Timestamptz()
  perfil        Perfil?
}

model Usuario_Esqueci_Senha {
  id            Int      @id @default(autoincrement())
  usuarioId     Int
  token         String   @unique @default(uuid())
  ativo         Boolean  @default(true)
  valido_ate    DateTime @default(now()) @db.Timestamptz()
  criado_em     DateTime @default(now()) @db.Timestamptz()
  atualizado_em DateTime @updatedAt @db.Timestamptz()
}

model Perfil {
  id                   String   @id @default(uuid())
  // INFORMAÇÕES BASICAS
  nome_completo        String
  apelido              String?
  data_nascimento      DateTime? @db.Date
  sexo                 String?
  cpf                  String?
  rg                   String?
  nacionalidade        String?
  estado_civil         String?
  cep                  String?
  endereco_rua         String?
  endereco_numero      String?
  endereco_complemento String?
  endereco_bairro      String?
  endereco_cidade      String?
  endereco_estado      String?
  telefone             String?
  redes_instagram      String?
  redes_linkedin       String?
  usuario       Usuario      @relation(fields: [usuarioId], references: [id])
  usuarioId     Int          @unique
  criado_em     DateTime     @default(now()) @db.Timestamptz()
  atualizado_em DateTime     @updatedAt @db.Timestamptz()
  Associacao    Associado?   @relation("PerfilDoAssociado")
  Documentos    Documentos[]
  Dependentes   Associado[]  @relation("PerfilDoResponsavel")
}

model Associado {
  id                                        String           @id @default(uuid())
  // SAÚDE
  saude_quadro_geral                        String?
  saude_uso_medicacao                       Boolean          @default(false)
  saude_uso_medicacao_nome                  String?
  saude_uso_terapeutico_canabis             Boolean          @default(false)
  saude_uso_terapeutico_canabis_experiencia String?
  saude_medico_prescritor                   Boolean          @default(false)
  saude_medico_prescritor_nome              String?
  saude_medico_prescritor_crm               String?
  tipo_associado                            TipoAssociado    @default(APOIADOR)
  elegivel_tarifa_social                    Boolean          @default(false)
  perfil                                    Perfil           @relation(name: "PerfilDoAssociado", fields: [perfilId], references: [id])
  perfilId                                  String           @unique
  responsavel                               Perfil?          @relation(name: "PerfilDoResponsavel", fields: [responsavelId], references: [id])
  responsavelId                             String?
  status                                    AssociacaoStatus @default(AGUARDANDO_CADASTRO)
  indicado_por                              String?          @db.VarChar(64)
  de_acordo_termo_associativo               Boolean?
  de_acordo_termo_associativo_em            DateTime?        @db.Timestamptz()

  criado_em     DateTime @default(now()) @db.Timestamptz()
  atualizado_em DateTime @updatedAt @db.Timestamptz()

  Documentos Documentos[]
  Pagamentos Pagamento[]
  Interesses Interesse[]

  @@index([responsavelId])
}

model Documentos {
  id           String        @id @default(uuid())
  tipo         TipoDocumento @default(NAO_IDENTIFICADO)
  nome_arquivo String
  associado    Associado     @relation(fields: [associadoId], references: [id])
  associadoId  String
  criado_por   Perfil?       @relation(fields: [criadoPorId], references: [id])
  criadoPorId  String?
  criado_em    DateTime      @default(now()) @db.Timestamptz()

  @@index([associadoId])
  @@index([criadoPorId])
}

model Pagamento {
  id                 String    @id @default(uuid())
  associado          Associado @relation(fields: [associadoId], references: [id])
  associadoId        String
  data_pagamento     DateTime  @default(now()) @db.Timestamptz()
  proximo_vencimento DateTime  @db.Date
  valor              Decimal?  @db.Decimal(10, 2)
  observacao         String?   @db.Text
  criado_em          DateTime  @default(now()) @db.Timestamptz()
  atualizado_em      DateTime  @updatedAt @db.Timestamptz()

  @@index([associadoId])
  @@index([proximo_vencimento])
}

model Remessa {
  id                String   @id @default(uuid())
  nome              String
  descricao         String?  @db.Text
  quantidade_total  Int
  quantidade_disponivel Int
  valor_unitario    Decimal? @db.Decimal(10, 2)
  data_limite       DateTime @db.Date
  ativa             Boolean  @default(true)
  criado_por_id     Int
  criado_em         DateTime @default(now()) @db.Timestamptz()
  atualizado_em     DateTime @updatedAt @db.Timestamptz()

  Interesses        Interesse[]

  @@index([ativa])
  @@index([data_limite])
}

model Interesse {
  id              String   @id @default(uuid())
  remessa         Remessa  @relation(fields: [remessaId], references: [id])
  remessaId       String
  associado       Associado @relation(fields: [associadoId], references: [id])
  associadoId     String
  quantidade      Int
  observacao      String?  @db.Text
  aprovado        Boolean  @default(false)
  criado_em       DateTime @default(now()) @db.Timestamptz()
  atualizado_em   DateTime @updatedAt @db.Timestamptz()

  @@index([remessaId])
  @@index([associadoId])
  @@unique([remessaId, associadoId])
}

model Logger {
  id        Int        @id @default(autoincrement())
  tipo_log  TipoLogger
  log       Json?
  criado_em DateTime   @default(now()) @db.Timestamptz()
}

model Contato {
  id            String     @id @default(uuid())
  nome          String
  email         String?
  telefone      String
  criado_em     DateTime   @default(now()) @db.Timestamptz()
  atualizado_em DateTime   @updatedAt @db.Timestamptz()
  Mensagens     Mensagem[]
  CheckMails    CheckMail[]

  @@unique([email, telefone])
}

model Mensagem {
  id            String     @id @default(uuid())
  contato       Contato    @relation(fields: [contatoId], references: [id])
  contatoId     String
  assunto       String?
  texto         String     @db.Text
  lido          Boolean    @default(false)
  respostaParaId String?
  remetente     Remetente  @default(FROM_CONTACT)
  criado_em     DateTime   @default(now()) @db.Timestamptz()

  @@index([contatoId])
  @@index([respostaParaId])
}

model CheckMail {
  id            String   @id @default(uuid())
  messageId     String   @unique // Identificador único do email (Message-ID)
  emailFrom     String   // Email de quem enviou
  emailTo       String   // Email destinatário
  inReplyTo     String?  // Identificador da mensagem que está respondendo
  salvo         Boolean  @default(false) // Flag se foi salvo como mensagem
  contatoId     String?  // FK para contato se foi vinculado
  contato       Contato? @relation(fields: [contatoId], references: [id])
  criado_em     DateTime @default(now()) @db.Timestamptz()
  atualizado_em DateTime @updatedAt @db.Timestamptz()

  @@index([messageId])
  @@index([inReplyTo])
  @@index([emailFrom])
  @@index([contatoId])
}

enum Papel {
  ADMIN
  ASSOCIADO
  ASSOCIADO_DEPENDENTE
  SECRETARIA
  SAUDE
}

enum TipoDocumento {
  NAO_IDENTIFICADO
  IDENTIFICACAO
  IDENTIFICACAO_RESPONSAVEL
  COMPROVANTE_RESIDENCIA
  RECEITA_MEDICA
  AUTORIZACAO_ANVISA
}

enum TipoAssociado {
  APOIADOR
  MEDICINAL
}

enum AssociacaoStatus {
  AGUARDANDO_CADASTRO
  AGUARDANDO_PAGAMENTO
  AGUARDANDO_ASSINATURA
  EM_ANALISE
  ASSOCIADO
}

enum TipoLogger {
  EMAIL
}

enum Remetente {
  FROM_CONTACT
  FROM_BENDITA
}
